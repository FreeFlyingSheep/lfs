# LFS 自动构建脚本

## 简介

**本项目还未完成！当前版本 `v0.5`。**

虽然本脚本已经经过一定测试，但仍然强烈建议在虚拟机中的 Linux 发行版上运行，避免损害主机系统。

本脚本的目的是自动构建 LFS，最终成果是一个虚拟磁盘文件，可以在 QEMU 和 VMware 中挂载运行。

如果希望在本地磁盘上构建 LFS 并实际使用它，可以修改本脚本，改为半自动的形式，同时不要略过测试工作。当然，更推荐按照官方手册手动去构建。

吐槽一下，如果你的目的是实际使用 LFS 系统，而不是简单“玩一下”，我认为该脚本的意义不大，你大概会感觉我写的很烂，然后考虑自己去写一个。

## 注意事项

- 默认采用 8 个作业进行构建。
- 确保脚本所在磁盘有至少 10G 的剩余空间。
- 该脚本运行过程中会创建 `lfs` 用户组及 `lfs` 用户，确保系统中没有重名的用户和用户组，否则它们会被删除。
- 确保 `/mnt/lfs` 目录不存在或为空，否则它会被删除！！！
- **对运行该脚本可能产生的一切后果，本人概不负责！！！**

对于自动构建 LFS，中途跑测试是很麻烦的，因为测试结果往往在不同主机上有不同的结果，没法用统一的标准去判断。尽管有些软件包的测试是必要的，但我们现在追求的是自动构建，而不是实际使用这个构建的系统（甚至整个构建都是在虚拟磁盘上完成的）。因此这里采取了最简单的办法，跳过所有难以评估的测试。即我们相信自动构建的 LFS 是正确的，如果它不正确，那么你可能需要针对你的运行环境执行额外的操作，最好的解决办法是手动构建。

## 如何运行

在 Linux 发行版上，运行以下命令：

    sudo su - # 切换到 root 用户
    bash build.sh # 执行自动构建脚本

确认宿主机环境正确配置后，输入 `1` 继续；反之输入 `2` 退出，完成环境配置后再次运行该脚本。

如果中途需要进行注销、关机、重启等可能卸载虚拟磁盘的操作，按 `ctrl + c` 终止脚本，然后**再次执行脚本，选择“保存状态”**，否则下次将无法正确运行。

## 脚本流程

详细内容可以参考脚本注释及 LFS 官方手册《[Linux From Scratch 版本 20200901-systemd，中文翻译版](https://bf.mengyan1223.wang/lfs/zh_CN/10.0-systemd/)》。

脚本内容按照该手册编排，尽可能按功能划分成了多个小脚本，为了实现全自动构建，修改了少部分指令。

### 0. 说明

该部分打印脚本信息。

### 1. 引言

确保执行脚本的用户为 `root`。

切换到脚本所在的目录，导出一些环境变量。

清理上次的构建（如果存在的话）。

### 2. 准备宿主系统

导出 `$LFS` 环境变量。

调用官方的 `version-check.sh` 脚本，打印宿主系统环境信息，给用户选择是否继续执行。

若用户选择继续执行，导出 `$LFS` 环境变量，创建虚拟磁盘，对其进行分区、格式化然后挂载。

### 3. 软件包和补丁

从官方镜像（服务器位于香港）下载 [lfs-packages-10.0.tar](https://mirror-hk.koddos.net/lfs/lfs-packages/lfs-packages-10.0.tar)，然后解包到 `$LFS/sources`。

现在源码内容位于 `$LFS/sources/10.0` 目录，移动目录中的内容到 `$LFS/sources`，之后删除空的 `10.0` 目录。

当然，用户也可以提前下载好软件包，放置到脚本目录。

### 4. 最后准备工作

创建目录布局，添加 `lfs` 用户，完成相关用户配置，之后切换到该用户并继续执行。

### 5. 编译交叉工具链

按序构建交叉工具链，具体请参考官方手册。

### 6. 交叉编译临时工具

按序交叉构建临时工具，具体请参考官方手册。

### 7. 进入 Chroot 并构建其他临时工具

进入 Chroot，按序构建其他临时工具，跳过了创建测试用户以及备份临时系统。

### 8. 安装基本系统软件

按序构建基本系统软件，跳过了所有难以评估的测试。

### 9. 系统配置

### 10. 使 LFS 系统可引导

### 11. 尾声

## 版本规划

- `v0.1`：初步完成步骤 `0 - 3`。
- `v0.2`：完善步骤 `0 - 3` ，初步完成步骤 `4`。
- `v0.3`：完善步骤 `4`，初步完成步骤 `5 - 7`。
- `v0.4`：完善步骤 `5 - 7`。
- `v0.5`：继续完善步骤 `5 - 7`。
- `v0.6`：初步完成步骤 `8`。
- `v0.7`：完善步骤 `8`，初步完成步骤 `9`。
- `v0.8`：完善步骤 `9`，初步完成步骤 `10 - 11`。
- `v0.9`：完善步骤 `10 - 11`，内测版。
- `v0.10`：重构部分代码，同时改善交互信息，公测版。
- `v1.0`：继续完善脚本，正式版。
